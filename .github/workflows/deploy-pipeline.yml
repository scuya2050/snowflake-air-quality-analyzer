name: Deploy Air Quality Pipeline SQL Objects

on:
  # Uncomment to enable automatic deployment on push
  # push:
  #   branches: [main]
  #   paths:
  #     - 'sql/ddl/**'
  #     - 'sql/dml/**'
  #     - '.github/workflows/deploy-pipeline.yml'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  SNOWFLAKE_DATABASE: DEV_DB
  SNOWFLAKE_SCHEMA: PUBLIC
  SNOWFLAKE_ROLE: ACCOUNTADMIN
  SNOWFLAKE_WAREHOUSE: ADHOC_WH

jobs:
  deploy-sql-objects:
    name: Deploy SQL Objects
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install Snowflake CLI via dpkg
        run: |
          # Download the .deb package
          curl -L -O https://sfc-repo.snowflakecomputing.com/snowflake-cli/linux_x86_64/3.15.0/snowflake-cli-3.15.0.x86_64.deb
          
          # Install the package
          sudo dpkg -i snowflake-cli-3.15.0.x86_64.deb
          
          # Verify installation
          snow --version
          echo "‚úÖ Snowflake CLI installed"
      
      - name: Configure Snowflake Connection
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ORGANIZATION_NAME }}-${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
        run: |  
          snow connection add \
            --connection-name deploy-conn \
            --account "$SNOWFLAKE_ACCOUNT" \
            --user "$SNOWFLAKE_USER" \
            --password "$SNOWFLAKE_PASSWORD" \
            --database "$SNOWFLAKE_DATABASE" \
            --schema "$SNOWFLAKE_SCHEMA" \
            --role "$SNOWFLAKE_ROLE" \
            --warehouse "$SNOWFLAKE_WAREHOUSE" \
            --default
            --no-interactive
          
          # Test connection
          snow connection test --connection deploy-conn
          echo "‚úÖ Connection configured and tested"
      
      - name: Deploy DDL - Stage Layer
        run: |
          echo "üìã Deploying Stage Layer..."
          snow sql -f sql/ddl/01-stage-layer.sql -c deploy-conn
          echo "‚úÖ Stage layer deployed"
      
      - name: Deploy DDL - Clean Layer
        run: |
          echo "üìã Deploying Clean Layer..."
          snow sql -f sql/ddl/02-clean-layer.sql -c deploy-conn
          echo "‚úÖ Clean layer deployed"
      
      - name: Deploy DDL - Consumption Layer
        run: |
          echo "üìã Deploying Consumption Layer..."
          snow sql -f sql/ddl/03-consumption-layer.sql -c deploy-conn
          echo "‚úÖ Consumption layer deployed"
      
      - name: Deploy DDL - Dimensional Model
        run: |
          echo "üìã Deploying Dimensional Model..."
          snow sql -f sql/ddl/04-dimensional-model.sql -c deploy-conn
          echo "‚úÖ Dimensional model deployed"
      
      - name: Deploy DML - Copy Task
        run: |
          echo "üìã Deploying Copy Task..."
          snow sql -f sql/dml/01-copy-task.sql -c deploy-conn
          echo "‚úÖ Copy task deployed"
      
      - name: Deployment Summary
        run: |
          echo "================================================"
          echo "‚úÖ Deployment completed successfully!"
          echo "================================================"
          echo "üóÑÔ∏è  DDL Scripts: All tables, views, and schemas created"
          echo "‚öôÔ∏è  DML Scripts: Tasks and operational objects configured"
          echo "üöÄ Pipeline is ready for data ingestion"
          echo "================================================"